//
// Created by frongere on 12/08/2021.
//

#include <fstream>
#include <filesystem>
#include "acme/acme.h"
#include "nlohmann/json.hpp"

using namespace acme;
using json = nlohmann::json;
namespace fs = std::filesystem;


template<typename T>
std::string str(T begin, T end) {
  std::stringstream ss;
  bool first = true;
  ss << "[";
  for (; begin != end; begin++) {
    if (!first)
      ss << ", ";
    ss << *begin;
    first = false;
  }
  ss << "]";
  return ss.str();
}


int main() {

  /**
   * Propeller definition
   */

  // Parameters

  PropellerParams propeller_params;
  propeller_params.m_diameter_m = 2.;
  propeller_params.m_screw_direction = RIGHT_HANDED;

  propeller_params.m_hull_wake_fraction_0 = 0.25;
  propeller_params.m_thrust_deduction_factor_0 = 0.2;

  // TODO: Donnees a ajouter dans le json
  propeller_params.m_use_advance_velocity_correction_factor = false;
  propeller_params.m_propeller_design_rpm;
  propeller_params.m_vessel_design_speed_ms;

  propeller_params.m_thrust_coefficient_correction = 0.;
  propeller_params.m_torque_coefficient_correction = 0.;


  // Perf data file

  std::string ktkq_json_string = R"({"j": [0, 0.01010101, 0.02020202, 0.03030303, 0.04040404, 0.05050505, 0.06060606, 0.07070707, 0.08080808, 0.09090909, 0.1010101, 0.11111111, 0.12121212, 0.13131313, 0.14141414, 0.15151515, 0.16161616, 0.17171717, 0.18181818, 0.19191919, 0.2020202, 0.21212121, 0.22222222, 0.23232323, 0.24242424, 0.25252525, 0.26262626, 0.27272727, 0.28282828, 0.29292929, 0.3030303, 0.31313131, 0.32323232, 0.33333333, 0.34343434, 0.35353535, 0.36363636, 0.37373737, 0.38383838, 0.39393939, 0.4040404, 0.41414141, 0.42424242, 0.43434343, 0.44444444, 0.45454545, 0.46464646, 0.47474747, 0.48484848, 0.49494949, 0.50505051, 0.51515152, 0.52525253, 0.53535354, 0.54545455, 0.55555556, 0.56565657, 0.57575758, 0.58585859, 0.5959596, 0.60606061, 0.61616162, 0.62626263, 0.63636364, 0.64646465, 0.65656566, 0.66666667, 0.67676768, 0.68686869, 0.6969697, 0.70707071, 0.71717172, 0.72727273, 0.73737374, 0.74747475, 0.75757576, 0.76767677, 0.77777778, 0.78787879, 0.7979798, 0.80808081, 0.81818182, 0.82828283, 0.83838384, 0.84848485, 0.85858586, 0.86868687, 0.87878788, 0.88888889, 0.8989899, 0.90909091, 0.91919192, 0.92929293, 0.93939394, 0.94949495, 0.95959596, 0.96969697, 0.97979798, 0.98989899, 1],
      "kt": [0.35422196, 0.35142214, 0.34857537, 0.34568216, 0.34274302, 0.33975846, 0.33672898, 0.3336551, 0.33053732, 0.32737615, 0.32417211, 0.3209257, 0.31763743, 0.31430781, 0.31093735, 0.30752656, 0.30407595, 0.30058602, 0.29705729, 0.29349026, 0.28988544, 0.28624335, 0.28256449, 0.27884937, 0.2750985,  0.27131239, 0.26749155, 0.26363649, 0.25974771, 0.25582573, 0.25187106, 0.24788419, 0.24386565, 0.23981594, 0.23573558, 0.23162506, 0.2274849,  0.22331562, 0.2191177,  0.21489168, 0.21063805, 0.20635733, 0.20205002, 0.19771663, 0.19335768, 0.18897366, 0.1845651,  0.1801325, 0.17567636, 0.17119721, 0.16669554, 0.16217186, 0.15762669, 0.15306054, 0.14847391, 0.14386731, 0.13924125, 0.13459624, 0.12993279, 0.12525141, 0.12055261, 0.1158369,  0.11110478, 0.10635677, 0.10159337, 0.09681509, 0.09202245, 0.08721595, 0.08239609, 0.0775634,  0.07271838, 0.06786154, 0.06299338, 0.05811442, 0.05322516, 0.04832612, 0.0434178,  0.03850072, 0.03357537, 0.02864228, 0.02370195, 0.01875488, 0.0138016,  0.0088426, 0.0038784, -0.0010905, -0.00606358, -0.01104034, -0.01602027, -0.02100285, -0.02598758, -0.03097396, -0.03596146, -0.04094959, -0.04593782, -0.05092567, -0.0559126, -0.06089813, -0.06588172, -0.07086289],
      "kq": [0.04336206,  0.04307767,  0.04278789,  0.04249279,  0.04219242,  0.04188681, 0.04157602,  0.04126011,  0.04093911,  0.04061307,  0.04028205,  0.03994609, 0.03960525,  0.03925957,  0.03890909,  0.03855388,  0.03819397,  0.03782941, 0.03746027,  0.03708657,  0.03670838,  0.03632574, 0.0359387,   0.0355473, 0.03515161,  0.03475165, 0.0343475,   0.03393919,  0.03352677,  0.03311029, 0.0326898, 0.03226534,  0.03183698, 0.03140475,  0.03096871,  0.0305289, 0.03008537,  0.02963817, 0.02918735,  0.02873296,  0.02827505,  0.02781366, 0.02734885,  0.02688066,  0.02640914,  0.02593434,  0.02545632,  0.02497511, 0.02449077,  0.02400334,  0.02351288,  0.02301943,  0.02252305,  0.02202377, 0.02152166,  0.02101675,  0.0205091,   0.01999876, 0.01948577,  0.01897018, 0.01845205, 0.01793141,  0.01740833, 0.01688284,  0.016355,    0.01582486, 0.01529246,  0.01475786,  0.0142211,   0.01368222,  0.01314129,  0.01259835, 0.01205344,  0.01150662,  0.01095793,  0.01040742, 0.00985515,  0.00930116, 0.0087455,  0.00818822,  0.00762936,  0.00706898,  0.00650712,  0.00594384, 0.00537918,  0.00481319,  0.00424592,  0.00367741,  0.00310773,  0.00253691, 0.001965,    0.00139206,  0.00081813,  0.00024326, -0.0003325,  -0.0009091, -0.0014865,  -0.00206464, -0.00264347, -0.00322295]
    })";


  /**
   * Rudder definition
   */

  // Parameters
  RudderParams rudder_params;
  rudder_params.m_hull_wake_fraction_0 = 0.4;
  rudder_params.m_chord_m = 2.;
  rudder_params.m_height_m = 2.;
  rudder_params.m_lateral_area_m2 = 4.;
  rudder_params.m_flap_slope = 0.;


  // Perf data file
  std::vector<double> flow_incidence_on_main_rudder_deg = {0.0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5,
                                                           6.0, 6.5, 7.0, 7.5, 8.0, 8.5, 9.0, 9.5, 10.0, 10.5, 11.0,
                                                           11.5, 12.0, 12.5, 13.0, 13.5, 14.0, 14.5, 15.0, 15.5, 16.0,
                                                           16.5, 17.0, 17.5, 18.0, 18.5, 19.0, 19.5, 20.0, 20.5, 21.0,
                                                           21.5, 22.0, 22.5, 23.0, 23.5, 24.0, 24.5, 25.0, 25.5, 26.0,
                                                           26.5, 27.0, 27.5, 28.0, 28.5, 29.0, 29.5};
  std::vector<double> cd = {0.005242994520813227, 0.0052593122236430645, 0.005304524675011635, 0.005369383841753006,
                            0.00546258594840765, 0.0055971271358430386, 0.00574638182297349, 0.005926867946982384,
                            0.006130721885710955, 0.006336485501378775, 0.0065806470811367035, 0.006838607136160135,
                            0.007111922837793827, 0.007392291445285082, 0.007715026382356882, 0.008049878291785717,
                            0.008432770147919655, 0.00883609801530838, 0.009282747283577919, 0.009774694219231606,
                            0.01028597541153431, 0.010809185914695263, 0.011343667283654213, 0.011870898306369781,
                            0.012423327192664146, 0.013044223189353943, 0.013721778057515621, 0.014402270317077637,
                            0.015245308168232441, 0.01603054814040661, 0.016893569380044937, 0.01791793294250965,
                            0.019129594787955284, 0.020396528765559196, 0.021983785554766655, 0.024000244215130806,
                            0.026631886139512062, 0.030220331624150276, 0.03397292643785477, 0.038746144622564316,
                            0.04477076604962349, 0.05246672034263611, 0.062327273190021515, 0.07487718015909195,
                            0.09083189815282822, 0.11012575030326843, 0.1333516240119934, 0.15840455889701843,
                            0.18181930482387543, 0.20162251591682434, 0.21787510812282562, 0.23202237486839294,
                            0.24202793836593628, 0.2515665888786316, 0.26081714034080505, 0.2699928879737854,
                            0.2778935134410858, 0.28736990690231323, 0.29664015769958496, 0.3049744665622711};
  std::vector<double> cl = {2.668157685548067e-05, 0.056529708206653595, 0.11289309710264206, 0.169301375746727,
                            0.2255769968032837, 0.281568706035614, 0.3373677134513855, 0.393011212348938,
                            0.4484163820743561, 0.5037611126899719, 0.5587046146392822, 0.6134940981864929,
                            0.6680029630661011, 0.722169816493988, 0.7754526734352112, 0.8278083801269531,
                            0.8795303702354431, 0.9344491958618164, 0.9938867092132568, 1.0560576915740967,
                            1.1179311275482178, 1.1796830892562866, 1.231227159500122, 1.2728246450424194,
                            1.316851258277893, 1.3624404668807983, 1.4079769849777222, 1.4532296657562256,
                            1.4956920146942139, 1.537797212600708, 1.5771914720535278, 1.607789158821106,
                            1.6346718072891235, 1.662453293800354, 1.6868847608566284, 1.7074735164642334,
                            1.7230695486068726, 1.7313636541366577, 1.7421339750289917, 1.746456503868103,
                            1.742898941040039, 1.728914737701416, 1.701988935470581, 1.6592025756835938,
                            1.5970512628555298, 1.5180244445800781, 1.4223109483718872, 1.326967477798462,
                            1.2516950368881226, 1.2011876106262207, 1.1712603569030762, 1.152787446975708,
                            1.1501551866531372, 1.1494742631912231, 1.1498548984527588, 1.1509875059127808,
                            1.1561044454574585, 1.1574681997299194, 1.1599279642105103, 1.1648073196411133};
  std::vector<double> cn = {-3.3430785606469726e-06, -5.317179602570832e-05, -8.336490282090381e-05,
                            -0.00011663855548249558, -0.00012940994929522276, -9.632209548726678e-05,
                            -2.6935964342555963e-05, 7.319641736103222e-05, 0.00022130433353595436, 0.00039575484697707,
                            0.0006507532671093941, 0.0009445527102798223, 0.0013044830411672592, 0.0017436686903238297,
                            0.002357420977205038, 0.0031629421282559633, 0.004063922446221113, 0.004182320553809404,
                            0.0032044483814388514, 0.0015387135790660977, -0.00010325611947337165,
                            -0.0017648303182795644, -0.0012634268496185541, 0.0013515892205759883,
                            0.0033826581202447414, 0.004945983644574881, 0.006401467137038708, 0.007820602506399155,
                            0.009575597010552883, 0.011331445537507534, 0.01341791357845068, 0.01689978316426277,
                            0.0205577053129673, 0.023595251142978668, 0.02647152543067932, 0.029054125770926476,
                            0.03119639679789543, 0.032685786485672, 0.03315171226859093, 0.032772988080978394,
                            0.03142339736223221, 0.028911132365465164, 0.02496742643415928, 0.01936887949705124,
                            0.011721551418304443, 0.0018627981189638376, -0.011114194057881832, -0.026692386716604233,
                            -0.04257682338356972, -0.056737612932920456, -0.06870502978563309, -0.07934681326150894,
                            -0.08721555024385452, -0.09486888349056244, -0.10244198888540268, -0.11000050604343414,
                            -0.11684787273406982, -0.12461866438388824, -0.13228511810302734, -0.1394384354352951};

  std::stringstream ss;
  ss << R"({"flow_incidence_on_main_rudder_deg": )"
     << str(flow_incidence_on_main_rudder_deg.begin(), flow_incidence_on_main_rudder_deg.end())
     << R"(, "Cd": )" << str(cd.begin(), cd.end())
     << R"(, "Cl": )" << str(cl.begin(), cl.end())
     << R"(, "Cn": )" << str(cn.begin(), cn.end())
     << R"(, "frame_convention": "NWU", "direction_convention": "COMEFROM")"
     << "}";

  std::string clcdcn_json_string = ss.str();


  /**
   * Propeller rudder construction
   */

  auto propeller_rudder = build_pr(E_FPP1Q, propeller_params, ktkq_json_string,
                                   E_SIMPLE_RUDDER, rudder_params, clcdcn_json_string);


  propeller_rudder->Initialize();


  // Calculation
  double water_density = 1025;
  double u_NWU_propeller_ms = 4;
  double v_NWU_propeller_ms = 0.3;
  double r_rads = 3 * MU_PI_180;
  double xr_m = 3;
  double rpm = 200;
  double pitch_ratio = 0.;
  double rudder_angle_deg = 10;


  propeller_rudder->Compute(water_density,
                            u_NWU_propeller_ms,
                            v_NWU_propeller_ms,
                            r_rads,
                            xr_m,
                            rpm,
                            pitch_ratio,
                            rudder_angle_deg);



//  std::cout << "Thrust: " << prop.GetThrust() * 1e-3 << " kN" << std::endl;
//  std::cout << "Torque: " << prop.GetTorque() * 1e-3 << " kN.m" << std::endl;
//  std::cout << "Efficiency: " << prop.GetPropellerEfficiency() << std::endl;
//  std::cout << "Power: " << prop.GetPower() * 1e-3 << " kW" << std::endl;


  return 0;
}